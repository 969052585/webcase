<script type="importmap">
    {
      "imports": {
        "vue": "../../js/vue.esm-browser.js"
      }
    }
</script>

<meta charset="utf8">
<title>在线格式化工具</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

<div id="app" class="flex justify-center p-4 md:p-6">
    <div class="w-full max-w-7xl">
        <!-- 控制区域 -->
        <div class="mb-4 md:mb-6 flex flex-col sm:flex-row flex-wrap items-start sm:items-center gap-3 md:gap-4">
            <h2 class="text-xl sm:text-2xl font-bold">在线格式化工具{{format}}</h2>

            <div class="flex flex-1 flex-col sm:flex-row items-start sm:items-center gap-2 md:gap-4">
                <div class="flex items-center gap-2 w-full sm:w-auto">
                    <label for="format-select" class="font-medium text-sm sm:text-base">选择格式：</label>
                    <select id="format-select" v-model="format" class="rounded border p-1 sm:p-2 text-sm sm:text-base">
                        <option value="json">JSON</option>
                        <option value="xml">XML</option>
                        <option value="html">HTML</option>
                        <option value="sql">SQL</option>
                    </select>
                </div>

                <div class="flex gap-2 w-full sm:w-auto">
                    <button @click="formatText"
                        class="rounded bg-blue-500 px-3 sm:px-4 py-1 sm:py-2 text-white hover:bg-blue-600 text-sm sm:text-base">
                        格式化
                    </button>
                    <button @click="clearAll"
                        class="rounded bg-red-500 px-3 sm:px-4 py-1 sm:py-2 text-white hover:bg-red-600 text-sm sm:text-base">
                        清空
                    </button>
                </div>
            </div>
        </div>

        <!-- 文本区域 -->
        <div class="flex flex-col lg:flex-row gap-3 md:gap-5">
            <div class="flex-1">
                <h3 class="mb-1 md:mb-2 text-lg font-semibold">源文本</h3>
                <textarea v-model="source" placeholder="请输入要格式化的内容..." rows="10"
                    class="w-full rounded border p-2 md:p-3 font-mono text-sm md:text-base"></textarea>
            </div>

            <div class="flex-1">
                <h3 class="mb-1 md:mb-2 text-lg font-semibold">格式化结果</h3>
                <div class="relative">
                    <pre
                        class="min-h-[10rem] md:min-h-[15rem] rounded border bg-gray-50 p-2 md:p-3 font-mono whitespace-pre-wrap text-sm md:text-base">{{ target || "格式化结果将显示在这里..." }}</pre>
                    <button @click="copyToClipboard"
                        class="absolute top-2 right-2 p-1 rounded bg-gray-200 hover:bg-gray-300 text-gray-700"
                        title="复制内容">
                        <i class="fa fa-clipboard"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    primary: '#3B82F6',
                    secondary: '#10B981',
                    accent: '#F59E0B',
                },
                fontFamily: {
                    inter: ['Inter', 'sans-serif'],
                },
            },
        }
    }
</script>

<script type="module">
    import { createApp } from 'vue'

    createApp({
        data() {
            return {
                source: '',
                target: '',
                format: 'xml'
            }
        },
        methods: {

            async copyToClipboard() {
                if (!this.target) return;

                try {
                    await navigator.clipboard.writeText(this.target);
                    // 可以添加一个复制成功的提示
                    // alert('内容已复制到剪贴板');
                } catch (err) {
                    console.error('复制失败:', err);
                    // 兼容性处理
                    const textarea = document.createElement('textarea');
                    textarea.value = this.target;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    // alert('内容已复制到剪贴板');
                }
            },
            formatText() {
                if (!this.source.trim()) {
                    this.target = "请输入要格式化的内容";
                    return;
                }

                try {
                    switch (this.format) {
                        case 'json':
                            this.target = this.formatJSON(this.source);
                            break;
                        case 'xml':
                            this.target = this.formatXML(this.source);
                            break;
                        case 'html':
                            this.target = this.formatHTML(this.source);
                            break;
                        case 'sql':
                            this.target = this.formatSQL(this.source);
                            break;
                        default:
                            this.target = this.source;
                    }
                } catch (e) {
                    this.target = `格式化错误: ${e.message}`;
                }
            },
            formatJSON(json) {
                const obj = JSON.parse(json);
                return JSON.stringify(obj, null, 2);
            },
            formatXML(xml) {
                let formatted = '';
                let indent = '';
                const trimmed = xml.trim();

                if (!trimmed.startsWith('<')) {
                    return trimmed;
                }

                const nodes = trimmed.split(/(<[^>]+>)/g).filter(node => node.trim());

                nodes.forEach(node => {
                    if (node.startsWith('</')) {
                        indent = indent.substring(2);
                        formatted += indent + node + '\n';
                    } else if (node.startsWith('<') && !node.endsWith('/>') && !node.match(/<\w+[^>]*>[^<>]*<\/\w+>/)) {
                        formatted += indent + node + '\n';
                        indent += '  ';
                    } else {
                        formatted += indent + node + '\n';
                    }
                });

                return formatted.trim();
            },
            formatHTML(html) {
                let formatted = '';
                let indent = 0;
                const lines = html.split(/(<[^>]+>)/g);

                lines.forEach(line => {
                    if (line.match(/^<\/\w/)) {
                        indent--;
                    }

                    formatted += '  '.repeat(indent) + line + '\n';

                    if (line.match(/^<\w[^>]*[^/]>.*$/) && !line.match(/^<(img|br|hr|input)/i)) {
                        indent++;
                    }
                });

                return formatted.trim();
            },
            formatSQL(sql) {
                const keywords = ['SELECT', 'FROM', 'WHERE', 'AND', 'OR', 'GROUP BY',
                    'ORDER BY', 'INSERT INTO', 'VALUES', 'UPDATE', 'SET',
                    'DELETE FROM', 'JOIN', 'LEFT JOIN', 'RIGHT JOIN', 'INNER JOIN'];

                let formatted = sql;
                keywords.forEach(kw => {
                    const regex = new RegExp(`\\b${kw}\\b`, 'gi');
                    formatted = formatted.replace(regex, `\n${kw}`);
                });

                return formatted.trim();
            },
            clearAll() {
                this.source = '';
                this.target = '';
            }
        }
    }).mount('#app')
</script>